<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Singapore Card Benefits Finder</title>
<style>
body {
  font-family: Arial, sans-serif;
  margin: 20px;
  background: #f5f7fa;
  color: #333;
}
h1 { text-align: center; color: #2c3e50; }
.container { max-width: 1000px; margin: auto; background: #fff; padding: 20px; border-radius: 10px; box-shadow: 0 0 15px rgba(0,0,0,0.1); }
input, select, button { padding: 8px; margin: 5px 0; border-radius: 5px; border: 1px solid #ccc; font-size: 14px; }
button { cursor: pointer; background-color: #2980b9; color: white; border: none; }
button:hover { background-color: #3498db; }
label { display: block; margin-top: 10px; font-weight: bold; }
#results-table { width: 100%; border-collapse: collapse; margin-top: 20px; }
#results-table th, #results-table td { border: 1px solid #ddd; padding: 8px; text-align: left; }
#results-table th { background-color: #2980b9; color: white; }
.owned { background-color: #dff0d8; }
.autocomplete-suggestions { border: 1px solid #ccc; max-height: 150px; overflow-y: auto; position: absolute; background: white; z-index: 1000; }
.autocomplete-suggestion { padding: 5px; cursor: pointer; }
.autocomplete-suggestion:hover { background: #3498db; color: white; }
.card-list { max-height: 150px; overflow-y: auto; border: 1px solid #ccc; padding: 5px; }
.card-item { display: flex; justify-content: space-between; padding: 5px; border-bottom: 1px solid #eee; }
.card-item button { background-color: #e74c3c; }
.card-item button:hover { background-color: #c0392b; }
</style>
</head>
<body>
<div class="container">
<h1>Singapore Card Benefits Finder</h1>

<label for="merchant-input">Merchant (type or use voice ðŸŽ¤)</label>
<input type="text" id="merchant-input" placeholder="Enter merchant name">
<button id="voice-btn">ðŸŽ¤ Speak</button>

<label for="available-cards">Add Card:</label>
<select id="available-cards"></select>
<button id="add-card-btn">Add</button>

<label>Your Cards:</label>
<div id="user-card-list" class="card-list"></div>

<button id="search-btn">Find Best Cards</button>

<table id="results-table">
  <thead>
    <tr>
      <th>Rank</th>
      <th>Card</th>
      <th>Benefit Types</th>
      <th>Details</th>
    </tr>
  </thead>
  <tbody></tbody>
</table>
</div>

<script>
// =================== Cards Data ===================
let cardsData = {};

// Load the JSON file dynamically
fetch('cards_merchants_enriched.json') // <-- replace with your JSON file path
  .then(response => {
    if (!response.ok) throw new Error('Failed to load JSON');
    return response.json();
  })
  .then(data => {
    cardsData = data;
    console.log('Cards data loaded:', cardsData);
    // You can now call a function to initialize autocomplete, populate card list, etc.
    initApp();
  })
  .catch(err => {
    console.error('Error loading JSON:', err);
  });

function initApp() {
  // Your app initialization code here
  console.log('App initialized with cards data.');
}

// =================== Globals ===================
let merchantList = [];
for (const bank in cardsData) {
  cardsData[bank].forEach(card => {
    for (const benefit in card.benefits) {
      card.benefits[benefit].merchants.forEach(m => {
        merchantList.push(m.name);
        m.aliases.forEach(a => merchantList.push(a));
      });
    }
  });
}
merchantList = [...new Set(merchantList)]; // unique

let userCards = []; // format: {bank, card}

// =================== Populate Add Card Dropdown ===================
const availableCardsSelect = document.getElementById('available-cards');
for (const bank in cardsData) {
  cardsData[bank].forEach(card => {
    const option = document.createElement('option');
    option.value = `${bank}||${card.card_name}`;
    option.text = `${bank} - ${card.card_name}`;
    availableCardsSelect.appendChild(option);
  });
}

// =================== Render User Cards ===================
function renderUserCards() {
  const list = document.getElementById('user-card-list');
  list.innerHTML = '';
  userCards.forEach((c, idx) => {
    const div = document.createElement('div');
    div.classList.add('card-item');
    div.innerHTML = `<span>${c.bank} - ${c.card}</span>
                     <button onclick="removeCard(${idx})">Remove</button>`;
    list.appendChild(div);
  });
}
function removeCard(idx) { userCards.splice(idx,1); renderUserCards(); }

// =================== Add Card ===================
document.getElementById('add-card-btn').addEventListener('click', () => {
  const val = availableCardsSelect.value;
  if (!val) return;
  const [bank, card] = val.split('||');
  if (!userCards.some(c=>c.bank===bank && c.card===card)) {
    userCards.push({bank, card});
    renderUserCards();
  }
});

// =================== Autocomplete ===================
const merchantInput = document.getElementById('merchant-input');
let suggestionsBox;
merchantInput.addEventListener('input', function() {
  const val = this.value.toLowerCase();
  closeSuggestions();
  if (!val) return;
  suggestionsBox = document.createElement('div');
  suggestionsBox.classList.add('autocomplete-suggestions');
  this.parentNode.appendChild(suggestionsBox);
  merchantList.forEach(merchant => {
    if (merchant.toLowerCase().includes(val)) {
      const div = document.createElement('div');
      div.classList.add('autocomplete-suggestion');
      div.innerText = merchant;
      div.addEventListener('click', () => {
        merchantInput.value = merchant;
        closeSuggestions();
      });
      suggestionsBox.appendChild(div);
    }
  });
});
function closeSuggestions() { if (suggestionsBox) suggestionsBox.remove(); }

// =================== Voice Input ===================
const voiceBtn = document.getElementById('voice-btn');
voiceBtn.addEventListener('click', () => {
  const recognition = new (window.SpeechRecognition || window.webkitSpeechRecognition)();
  recognition.lang = 'en-US';
  recognition.start();
  recognition.onresult = function(event) {
    merchantInput.value = event.results[0][0].transcript;
    recognition.stop();
  };
});

// =================== Find Best Cards ===================
document.getElementById('search-btn').addEventListener('click', findBestCards);

function findBestCards() {
  const merchant = merchantInput.value.trim().toLowerCase();
  const results = [];

  for (const bank in cardsData) {
    cardsData[bank].forEach(card => {
      let totalScore = 0;
      let benefitDetails = [];

      for (const benefit in card.benefits) {
        card.benefits[benefit].merchants.forEach(m => {
          if (m.name.toLowerCase() === merchant || m.aliases.some(a => a.toLowerCase() === merchant)) {
            const desc = card.benefits[benefit].description;
            let score = 0;
            const match = desc.match(/(\d+\.?\d*)/);
            if (match) score = parseFloat(match[1]);
            totalScore += score;
            benefitDetails.push({type: benefit, description: desc, score});
          }
        });
      }

      if (benefitDetails.length > 0) {
        results.push({
          bank, card: card.card_name, totalScore, benefitDetails,
          owned: userCards.some(c=>c.bank===bank && c.card===card.card_name)
        });
      }
    });
  }

  results.sort((a,b) => b.totalScore - a.totalScore);
  const tbody = document.querySelector('#results-table tbody');
  tbody.innerHTML = '';
  results.forEach((r,i) => {
    const tr = document.createElement('tr');
    if (r.owned) tr.classList.add('owned');
    const benefitsText = r.benefitDetails.map(d => `${d.type}: ${d.description}`).join('<br>');
    tr.innerHTML = `<td>${i+1}</td>
                    <td>${r.bank} - ${r.card}</td>
                    <td>${r.benefitDetails.map(d=>d.type).join(', ')}</td>
                    <td>${benefitsText}</td>`;
    tbody.appendChild(tr);
  });
}
</script>
</body>
</html>
