<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>Credit Card Offers</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <style>
    body { font-family: Arial, sans-serif; background: #f9f9f9; padding: 10px; margin: 0; }
    h1 { text-align: center; font-size: 1.6em; }
    .container { max-width: 900px; margin: 0 auto; padding: 10px; }
    .box {
      background: white; padding: 15px; border-radius: 10px;
      margin-bottom: 15px; box-shadow: 0 2px 5px rgba(0,0,0,0.1);
    }
    h2 { font-size: 1.2em; margin-top: 0; }

    input[type="text"], select {
      width: 100%; padding: 12px; font-size: 1em;
      margin-bottom: 10px; border: 1px solid #ccc; border-radius: 5px;
    }

    button {
      padding: 12px 16px; font-size: 1em; margin: 5px 0;
      cursor: pointer; border: none; border-radius: 5px;
      background: #007bff; color: white; width: 100%;
    }
    button:hover { background: #0056b3; }

    ul { list-style: none; padding: 0; }
    li {
      margin: 5px 0; padding: 12px;
      background: #f1f1f1; border-radius: 6px; font-size: 0.95em;
    }

    .autocomplete-suggestions {
      border: 1px solid #ccc; max-height: 150px; overflow-y: auto;
      position: absolute; background: white; width: calc(100% - 20px);
      z-index: 1000;
    }
    .autocomplete-suggestion { padding: 10px; cursor: pointer; }
    .autocomplete-suggestion:hover { background: #eee; }

    /* Highlight user cards */
    .user-card { background: #d1ecf1 !important; border-left: 4px solid #17a2b8; }

    /* Mobile adjustments */
    @media (max-width: 600px) {
      h1 { font-size: 1.3em; }
      h2 { font-size: 1.1em; }
      button { font-size: 0.9em; padding: 10px; }
      input[type="text"], select { font-size: 0.9em; }
    }
  </style>
</head>
<body>
  <div class="container">
    <h1>Credit Card Offers</h1>

    <!-- Search -->
    <div class="box">
      <h2>Search Merchant</h2>
      <input type="text" id="merchant-input" placeholder="Enter merchant or category...">
      <div id="autocomplete" class="autocomplete-suggestions"></div>
      <button id="search-btn">Fetch Best Card Offers</button>
      <button id="voice-btn">ðŸŽ¤ Speak</button>
    </div>
    
    <!-- Results FIRST -->
    <div class="box">
      <h2>Best Card Suggestions</h2>
      <ul id="results-list"><li>Enter a merchant or category to see offers.</li></ul>
    </div>

    <!-- User cards -->
    <div class="box">
      <h2>Your Cards</h2>
      <select id="add-card-select"></select>
      <button id="add-card-btn">Add Card</button>
      <ul id="user-cards-list"></ul>
    </div>
  </div>

  <!-- Load cards dataset -->
  <script src="cardsData.js"></script>

  <!-- App Logic -->
  <script>
    const merchantInput = document.getElementById('merchant-input');
    const autocompleteBox = document.getElementById('autocomplete');
    const userCards = JSON.parse(localStorage.getItem("userCards") || "[]");
    const addCardSelect = document.getElementById('add-card-select');
    const userCardsList = document.getElementById('user-cards-list');

    /* ============ Keyword â†’ Category Mapping ============ */
    const keywordToCategory = {
      "pizza": "dining",
      "restaurant": "dining",
      "food": "dining",
      "cafe": "dining",
      "groceries": "supermarkets",
      "supermarket": "supermarkets",
      "ntuc": "supermarkets",
      "fairprice": "supermarkets",
      "cold storage": "supermarkets",
      "shopee": "online_shopping",
      "lazada": "online_shopping",
      "grab": "transport",
      "uber": "transport",
      "gocar": "transport",
      "comfortdelgro": "transport",
      "singtel": "utilities",
      "starhub": "utilities",
      "m1": "utilities",
      "sp group": "utilities",
      "shell": "petrol",
      "esso": "petrol",
      "caltex": "petrol",
      "movie": "entertainment",
      "cinema": "entertainment",
      "netflix": "entertainment",
      "doctor": "health_wellness",
      "clinic": "health_wellness",
      "hospital": "health_wellness",
      "pharmacy": "health_wellness"
    };

    /* ============ Build Merchant + Category List ============ */
    let merchantsList = [];
    for (const bank in cardsData) {
      cardsData[bank].forEach(card => {
        for (const cat in card.benefits) {
          const benefit = card.benefits[cat];
          if (benefit.merchants) {
            benefit.merchants.forEach(m => merchantsList.push(m.name));
          }
          merchantsList.push(cat);
        }
      });
    }
    merchantsList = [...new Set(merchantsList)];

    /* ============ Autocomplete ============ */
    merchantInput.addEventListener('input', () => {
      const query = merchantInput.value.toLowerCase();
      autocompleteBox.innerHTML = '';
      if (query.length > 0) {
        const suggestions = merchantsList.filter(m => m.toLowerCase().includes(query));
        suggestions.forEach(s => {
          const div = document.createElement('div');
          div.className = 'autocomplete-suggestion';
          div.textContent = s;
          div.onclick = () => {
            merchantInput.value = s;
            autocompleteBox.innerHTML = '';
          };
          autocompleteBox.appendChild(div);
        });
      }
    });

    /* ============ Voice Input ============ */
    document.getElementById('voice-btn').addEventListener('click', () => {
      const recognition = new (window.SpeechRecognition || window.webkitSpeechRecognition)();
      recognition.lang = 'en-SG';
      recognition.start();
      recognition.onresult = e => { merchantInput.value = e.results[0][0].transcript; };
    });

    /* ============ User Cards ============ */
    for (const bank in cardsData) {
      cardsData[bank].forEach(card => {
        const option = document.createElement('option');
        option.value = bank + '|' + card.card_name;
        option.textContent = `${bank} - ${card.card_name}`;
        addCardSelect.appendChild(option);
      });
    }


// Render on page load
renderUserCards();

document.getElementById('add-card-btn').addEventListener('click', () => {
  const val = addCardSelect.value;
  if (!userCards.includes(val)) {
    userCards.push(val);
    localStorage.setItem("userCards", JSON.stringify(userCards));
    renderUserCards();
  }
});

function renderUserCards() {
  userCardsList.innerHTML = '';
  userCards.forEach(c => {
    const li = document.createElement('li');
    li.textContent = c;
    const removeBtn = document.createElement('button');
    removeBtn.textContent = 'Remove';
    removeBtn.style.background = '#dc3545';
    removeBtn.style.marginLeft = '10px';
    removeBtn.onclick = () => {
      const idx = userCards.indexOf(c);
      if (idx > -1) {
        userCards.splice(idx, 1);
        localStorage.setItem("userCards", JSON.stringify(userCards));
        renderUserCards();
      }
    };
    li.appendChild(removeBtn);
    userCardsList.appendChild(li);
  });
}

    /* ============ Find Best Cards with Smart Mapping ============ */
    document.getElementById('search-btn').addEventListener('click', findBestCards);

    function findBestCards() {
      let merchant = merchantInput.value.trim().toLowerCase();

      // Check keyword mapping
      if (keywordToCategory[merchant]) {
        merchant = keywordToCategory[merchant];
      } else {
        // Try partial matches (e.g., "pizza hut" contains "pizza")
        for (const key in keywordToCategory) {
          if (merchant.includes(key)) {
            merchant = keywordToCategory[key];
            break;
          }
        }
      }

      const results = [];

      for (const bank in cardsData) {
        cardsData[bank].forEach(card => {
          let match = false;
          let benefitDetails = [];

          for (const cat in card.benefits) {
            const benefit = card.benefits[cat];

            // Exact merchant match
            if (benefit.merchants && benefit.merchants.some(m => m.name.toLowerCase() === merchant)) {
              match = true;
              benefitDetails.push(`${benefit.description} at ${merchant}`);
            }
            // Category match
            else if (cat.toLowerCase() === merchant) {
              match = true;
              benefitDetails.push(`${benefit.description} (${cat})`);
            }
            // Fallback: partial match in description
            else if (benefit.description.toLowerCase().includes(merchant)) {
              match = true;
              benefitDetails.push(`${benefit.description} (${cat})`);
            }
          }

          if (match) {
            const isUserCard = userCards.some(c => c === bank + '|' + card.card_name);
            results.push({
              bank,
              card: card.card_name,
              benefits: benefitDetails,
              priority: isUserCard ? 1 : 0
            });
          }
        });
      }

      results.sort((a, b) => b.priority - a.priority);
      renderResults(results);
    }

    function renderResults(results) {
      const resultsList = document.getElementById('results-list');
      const valueVar = 0;
      resultsList.innerHTML = '';
      if (results.length === 0) {
        resultsList.innerHTML = '<li>No matching benefits found. Try keywords like "pizza", "groceries", "uber".</li>';
      } else {
        results.forEach(r => {
          if (valueVar === 5) {return;}
          const li = document.createElement('li');
          li.className = r.priority === 1 ? "user-card" : "";
          li.innerHTML = `<strong>${r.bank} - ${r.card}</strong><br>${r.benefits.join('<br>')}`;
          resultsList.appendChild(li);
          valueVar += 1;
        });
      }
    }
  </script>
</body>
</html>
