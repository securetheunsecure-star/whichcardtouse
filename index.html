<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>Credit Card Offers</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <style>
    body { font-family: Arial, sans-serif; background: #f9f9f9; padding: 10px; margin: 0; }
    h1 { text-align: center; font-size: 1.6em; }
    .container { max-width: 900px; margin: 0 auto; padding: 10px; }
    .box {
      background: white; padding: 15px; border-radius: 10px;
      margin-bottom: 15px; box-shadow: 0 2px 5px rgba(0,0,0,0.1);
    }
    h2 { font-size: 1.2em; margin-top: 0; }

    input[type="text"], select {
      width: 100%; padding: 12px; font-size: 1em;
      margin-bottom: 10px; border: 1px solid #ccc; border-radius: 5px;
    }

    button {
      padding: 12px 16px; font-size: 1em; margin: 5px 0;
      cursor: pointer; border: none; border-radius: 5px;
      background: #007bff; color: white; width: 100%;
    }
    button:hover { background: #0056b3; }

    ul { list-style: none; padding: 0; }
    li {
      margin: 5px 0; padding: 12px;
      background: #f1f1f1; border-radius: 6px; font-size: 0.95em;
    }

    .autocomplete-suggestions {
      border: 1px solid #ccc; max-height: 150px; overflow-y: auto;
      position: absolute; background: white; width: calc(100% - 20px);
      z-index: 1000;
    }
    .autocomplete-suggestion { padding: 10px; cursor: pointer; }
    .autocomplete-suggestion:hover { background: #eee; }

    /* Highlight user cards */
    .user-card { background: #d1ecf1 !important; border-left: 4px solid #17a2b8; }

    /* Mobile adjustments */
    @media (max-width: 600px) {
      h1 { font-size: 1.3em; }
      h2 { font-size: 1.1em; }
      button { font-size: 0.9em; padding: 10px; }
      input[type="text"], select { font-size: 0.9em; }
    }

.results-table {
  width: 100%;
  border-collapse: collapse;
  margin-top: 15px;
  font-size: 14px;
}

.results-table th, .results-table td {
  border: 1px solid #ddd;
  padding: 8px;
  text-align: left;
}

.results-table th {
  background-color: #007bff;
  color: white;
}

.results-table tr:nth-child(even) {
  background-color: #f9f9f9;
}

.tag {
  background: #28a745;
  color: white;
  padding: 2px 6px;
  border-radius: 4px;
  font-size: 12px;
}

  </style>
</head>
<body>
  <div class="container">
    <h1>Credit Card Offers</h1>

    <!-- Search -->
    <div class="box">
      <h2>Search Merchant</h2>
      <input type="text" id="merchant-input" placeholder="Enter merchant or category...">
      <div id="autocomplete" class="autocomplete-suggestions"></div>
      <button id="search-btn">Fetch Best Card Offers</button>
      <button id="voice-btn">ðŸŽ¤ Speak</button>
    </div>
    
    <!-- Results FIRST -->
    <div class="box">
      <h2>Best Card Suggestions</h2>
      <ul id="results-list"><li>Enter a merchant or category to see offers.</li></ul>
    </div>

    <!-- User cards -->
    <div class="box">
      <h2>Your Cards</h2>
      <select id="add-card-select"></select>
      <button id="add-card-btn">Add Card</button>
      <ul id="user-cards-list"></ul>
    </div>
  </div>

  <!-- Load cards dataset -->
  <script src="cardsData.js"></script>

  <!-- App Logic -->
  <script>
    const merchantInput = document.getElementById('merchant-input');
    const autocompleteBox = document.getElementById('autocomplete');
    const userCards = JSON.parse(localStorage.getItem("userCards") || "[]");
    const addCardSelect = document.getElementById('add-card-select');
    const userCardsList = document.getElementById('user-cards-list');

    /* ============ Keyword â†’ Category Mapping ============ */
    const keywordToCategory = {
      "pizza": "dining",
      "restaurant": "dining",
      "food": "dining",
      "cafe": "dining",
      "groceries": "supermarkets",
      "supermarket": "supermarkets",
      "ntuc": "supermarkets",
      "fairprice": "supermarkets",
      "cold storage": "supermarkets",
      "shopee": "online_shopping",
      "lazada": "online_shopping",
      "grab": "transport",
      "uber": "transport",
      "gocar": "transport",
      "comfortdelgro": "transport",
      "singtel": "utilities",
      "starhub": "utilities",
      "m1": "utilities",
      "sp group": "utilities",
      "shell": "petrol",
      "esso": "petrol",
      "caltex": "petrol",
      "movie": "entertainment",
      "cinema": "entertainment",
      "netflix": "entertainment",
      "doctor": "health_wellness",
      "clinic": "health_wellness",
      "hospital": "health_wellness",
      "pharmacy": "health_wellness"
    };

    /* ============ Build Merchant + Category List ============ */
    let merchantsList = [];
    for (const bank in cardsData) {
      cardsData[bank].forEach(card => {
        for (const cat in card.benefits) {
          const benefit = card.benefits[cat];
          if (benefit.merchants) {
            benefit.merchants.forEach(m => merchantsList.push(m.name));
          }
          merchantsList.push(cat);
        }
      });
    }
    merchantsList = [...new Set(merchantsList)];

    /* ============ Autocomplete ============ */
    merchantInput.addEventListener('input', () => {
      const query = merchantInput.value.toLowerCase();
      autocompleteBox.innerHTML = '';
      if (query.length > 0) {
        const suggestions = merchantsList.filter(m => m.toLowerCase().includes(query));
        suggestions.forEach(s => {
          const div = document.createElement('div');
          div.className = 'autocomplete-suggestion';
          div.textContent = s;
          div.onclick = () => {
            merchantInput.value = s;
            autocompleteBox.innerHTML = '';
          };
          autocompleteBox.appendChild(div);
        });
      }
    });

    /* ============ Voice Input ============ */
    document.getElementById('voice-btn').addEventListener('click', () => {
      const recognition = new (window.SpeechRecognition || window.webkitSpeechRecognition)();
      recognition.lang = 'en-SG';
      recognition.start();
      recognition.onresult = e => { merchantInput.value = e.results[0][0].transcript; };
    });

    /* ============ User Cards ============ */
    for (const bank in cardsData) {
      cardsData[bank].forEach(card => {
        const option = document.createElement('option');
        option.value = bank + '|' + card.card_name;
        option.textContent = `${bank} - ${card.card_name}`;
        addCardSelect.appendChild(option);
      });
    }


// Render on page load
renderUserCards();

document.getElementById('add-card-btn').addEventListener('click', () => {
  const val = addCardSelect.value;
  if (!userCards.includes(val)) {
    userCards.push(val);
    localStorage.setItem("userCards", JSON.stringify(userCards));
    renderUserCards();
  }
});

function renderUserCards() {
  userCardsList.innerHTML = '';
  userCards.forEach(c => {
    const li = document.createElement('li');
    li.textContent = c;
    const removeBtn = document.createElement('button');
    removeBtn.textContent = 'Remove';
    removeBtn.style.background = '#dc3545';
    removeBtn.style.marginLeft = '10px';
    removeBtn.onclick = () => {
      const idx = userCards.indexOf(c);
      if (idx > -1) {
        userCards.splice(idx, 1);
        localStorage.setItem("userCards", JSON.stringify(userCards));
        renderUserCards();
      }
    };
    li.appendChild(removeBtn);
    userCardsList.appendChild(li);
  });
}

    /* ============ Find Best Cards with Smart Mapping ============ */
    document.getElementById('search-btn').addEventListener('click', findBestCards);

function findBestCards() {
  const merchantInputValue = merchantInput.value.trim().toLowerCase();
  const resultsContainer = document.getElementById('results-list');
  resultsContainer.innerHTML = "";

  if (!merchantInputValue) {
    resultsContainer.innerHTML = "<p>Please enter a merchant or category.</p>";
    return;
  }

  const results = [];
  let matchedCategory = mapMerchantToCategory(merchantInputValue);

  for (const bank in cardsData) {
    cardsData[bank].forEach(card => {
      let matched = false;
      let score = 0;
      let benefitDetail = "";

      for (const [cat, details] of Object.entries(card.benefits)) {
        // Merchant-level match
        if (details.merchants) {
          const found = details.merchants.find(m =>
            m.name.toLowerCase() === merchantInputValue ||
            m.aliases?.some(a => a.toLowerCase() === merchantInputValue)
          );
          if (found) {
            matched = true;
            score = computeScore(details.description);
            benefitDetail = `${details.description} (${cat})`;
          }
        }

        // Category fallback
        if (!matched && matchedCategory && cat === matchedCategory) {
          matched = true;
          score = computeScore(details.description) * 0.8;
          benefitDetail = `${details.description} (${cat} - fallback)`;
        }
      }

      if (matched) {
        results.push({
          bank,
          card: card.card_name,
          score,
          benefitDetail,
          isUserCard: userCards.includes(card.card_name)
        });
      }
    });
  }

  if (results.length === 0) {
    resultsContainer.innerHTML = `<p>No strong matches found for "${merchantInputValue}".</p>`;
    return;
  }

  // Sort & take top 5
  results.sort((a, b) => {
    if (a.isUserCard && !b.isUserCard) return -1;
    if (!a.isUserCard && b.isUserCard) return 1;
    return b.score - a.score;
  });
  const topResults = results.slice(0, 5);

  // Render as table
  const table = document.createElement("table");
  table.className = "results-table";
  table.innerHTML = `
    <thead>
      <tr>
        <th>Card</th>
        <th>Bank</th>
        <th>Benefit</th>
        <th>Score</th>
        <th>Tag</th>
      </tr>
    </thead>
    <tbody>
      ${topResults.map(r => `
        <tr>
          <td>${r.card}</td>
          <td>${r.bank}</td>
          <td>${r.benefitDetail}</td>
          <td>${r.score.toFixed(2)}</td>
          <td>${r.isUserCard ? "<span class='tag'>My Card</span>" : ""}</td>
        </tr>
      `).join("")}
    </tbody>
  `;
  resultsContainer.appendChild(table);
}

// -------------------------
// Helper: map merchant to category
// -------------------------
function mapMerchantToCategory(input) {
  if (input.includes("pizza") || input.includes("restaurant") || input.includes("food")) return "dining";
  if (input.includes("grocer") || input.includes("supermarket")) return "supermarkets";
  if (input.includes("petrol") || input.includes("esso") || input.includes("shell")) return "petrol";
  if (input.includes("travel") || input.includes("flight") || input.includes("hotel")) return "travel";
  if (input.includes("shop") || input.includes("online")) return "online_shopping";
  if (input.includes("utility") || input.includes("bill") || input.includes("electric")) return "utilities";
  if (input.includes("movie") || input.includes("netflix") || input.includes("cinema")) return "entertainment";
  return null;
}

// -------------------------
// Helper: compute score from description
// -------------------------
function computeScore(desc) {
  let score = 1;
  const percentMatch = desc.match(/(\d+)%/);
  if (percentMatch) score = parseInt(percentMatch[1]);
  else if (desc.includes("mpd")) score = 50; // arbitrary base score for miles
  else if (desc.includes("point")) score = 20;
  return score;
}
  </script>
</body>
</html>
